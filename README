                        動的エントロピー計測器

                                                        Haruaki Tamada
                                                        2012.3.18 (Sun)

* はじめに

  このツールは計測対象となるJavaプログラムがどのような命令を実行してい
るのか計測するためのツールです．Agentとして起動し，クラスファイルのロー
ド後に計測する命令を挿入するようクラスファイルを書き換え，実行します．
実行後は，プログラム終了時にそれまで実行された命令列の順番と頻度をcsv形
式で出力します．

* 計測方法

  このツールは，２種類の実行方法があります．１つ目は，計測するためのコー
ドを埋め込む変換を静的に行う方法です．もう一つはプログラムロード時に，
クラスファイルを書き換え，そのまま実行する方法です．両方とも，プログラ
ム終了時に計測結果を標準出力に出力します．出力内容はインストラクション
の実行トレースと，その頻度です．

  本ツールでは，実行されたインストラクションの計測・収集のために，コー
ドをクラスファイルに埋め込みます．例として，以下のHelloWorldで説明しま
す．

<code>
public class HelloWorld{
    public static void main(String[] args){
        System.out.println("Hello World");
    }
}</code>

このプログラムをコンパイルすると，以下のようなバイトコードに変換されま
す．コンスタントプールは無視しています．

<code>
public HelloWorld()
  Code:
   0:	aload_0
   1:	invokespecial	#1; //Method java/lang/Object."<init>":()V
   4:	return

public static void main(java.lang.String[]);
  Code:
   0:	getstatic	#2; //Field java/lang/System.out:Ljava/io/PrintStream;
   3:	ldc	#3; //String Hello World
   5:	invokevirtual	#4; //Method java/io/PrintStream.println:(Ljava/lang/String;)V
   8:	return
</code>

このツールは上記バイトコードの命令1つずつ集計のためのメソッド呼び出しを
加えていきます．

<code>
public HelloWorld()
  Code:
   0:	ldc	#7; //String HelloWorld
   2:	ldc	#8; //String <init>
   4:	invokestatic	#14; //Method entropy/EntropyCounterManager.entryMethod:(Ljava/lang/String;Ljava/lang/String;)V
   7:	invokestatic	#17; //Method entropy/EntropyCounterManager.aload:()V
   10:	aload_0
   11:	invokestatic	#20; //Method entropy/EntropyCounterManager.invokespecial:()V
   14:	invokespecial	#22; //Method java/lang/Object."<init>":()V
   17:	invokestatic	#25; //Method entropy/EntropyCounterManager.returnMethod:()V
   20:	invokestatic	#28; //Method entropy/EntropyCounterManager.returnInsn:()V
   23:	return

public static void main(java.lang.String[]);
  Code:
   0:	ldc	#7; //String HelloWorld
   2:	ldc	#31; //String main
   4:	invokestatic	#14; //Method entropy/EntropyCounterManager.entryMethod:(Ljava/lang/String;Ljava/lang/String;)V
   7:	invokestatic	#34; //Method entropy/EntropyCounterManager.getstatic:()V
   10:	getstatic	#40; //Field java/lang/System.out:Ljava/io/PrintStream;
   13:	invokestatic	#43; //Method entropy/EntropyCounterManager.ldc:()V
   16:	ldc	#45; //String Hello World
   18:	invokestatic	#48; //Method entropy/EntropyCounterManager.invokevirtual:()V
   21:	invokevirtual	#54; //Method java/io/PrintStream.println:(Ljava/lang/String;)V
   24:	invokestatic	#25; //Method entropy/EntropyCounterManager.returnMethod:()V
   27:	invokestatic	#28; //Method entropy/EntropyCounterManager.returnInsn:()V
   30:	return
</code>

プログラムが終了するときに，今まで集計した結果を出力します．上記の例で
あれば，以下のような出力になります．

<code>
Hello World
############### execution trace (opcode,name) ###############
178,getstatic
18,ldc
182,invokevirtual
177,return
############### frequency of trace (opcode,name,freq) ###############
18,ldc,1
177,return,1
178,getstatic,1
182,invokevirtual,1
</code>

* 使い方

** 変換のみを行う場合

  通常はこちらの起動方法で起動します．以下のように，javaコマンドの-jar
オプションに渡せば実行できます．

> $ java -jar entropy-1.0-SNAPSHOT.jar [OPTIONS] <TARGETS...>
> 
> OPTIONS
>   -d, --dest <dest>: set output destination. Default is current directory.
>   -h, --help:        show this message
> 
> TARGETS
>   only accept Java class files.

-d は変換後のクラスファイルの出力先を表します．デフォルトはカレントディ
レクトリです．変換後のプログラムは，このjarファイル
(entropy-1.0-SNAPSHOT.jar)にもクラスパスを通さなければ，実行できなくな
ります．


** Java Agentとして起動

  必要なところにクラスパスを通しておかなくてはいけません．具体的には以
下のようなコマンドで実行します．以下は複数業に分けて書いていますが，実
際は１行で書いてください．配布ファイルのトップディレクトリで実行します
(src, target, pom.xml, READMEの4つのファイル，ディレクトリが存在するディ
レクトリ)．

> $ java -javaagent target/entropy-1.0-SNAPSHOT.jar 
>        -classpath 'target/entropy-1.0-SNAPSHOT.jar:XXXXX'
>        YYYYY

ここで，YYYYYは計測対象となるクラスファイルの指定，XXXXXはYYYYYが存在す
るディレクトリもしくはjarファイルのパスです．計測しない場合は以下のよう
に実行されるはずです．

$ java -classpath XXXXX YYYYY

実行後，現在のディレクトリに hoge ディレクトリが作成され，変換されたク
ラスファイルが出力されるようになっています．そのディレクトリ内のクラス
ファイルを対象に静的に分析できるようになっています．

** 変換対象

変換対象は src/main/java/entropy/DefaultTransfomFilter.java で制御され
ています．java, javax, sun, sunw, org.apache, などのパッケージで始まる
クラスは変換対象外となっています．必要に応じて，上記クラスを書き換えて
ください．

* 依存ライブラリ

このツールは以下のライブラリを使用しています．

 * Maven 3 (コンパイルに用いています)
 * asm 4.0 (バイトコードの書き換えに用いています)

ツールのディレクトリで，mvn package と入力すれば，コンパイルされ，
target ディレクトリに entropy-1.0-SNAPSHOT.jar が作成されます．

* 連絡先

〒603-8555 京都市北区上賀茂本山
京都産業大学 コンピュータ理工学部
玉田 春昭
mailto:tamada@cse.kyoto-su.ac.jp
